# V6→V7 对照清单（继承 / 改动 / 新增）

| 层级 | V6 目录/文件 | V7 处理动作 | 说明 |
|---|---|---|---|
| 治理 governance | `governance/SCHEMA_*.json`, `RULES_library.yaml`, `CONTROL_switch_policy.yaml` | **改动** | 需在 V7 中纳入 clusterer_config、label_map、prototype_drift、clarity 等新字段，并扩展 RULES 触发器（transition、low_confidence）与门控策略。 |
| 数据 data | `data/alignment/`, `data/preprocessing/` | **继承** | 继续沿用 ATAS 导入、会话对齐、行情拉取与清洗模块，同时补充 V7 要求的 macro_factor 慢锚生成。 |
| 特征 features | `features/macro_factor/` | **继承+新增** | 复用 V6 级联指标计算与公共工具，新增 macro_factor 慢锚配置及 rolling_cluster_labeler 管线。 |
| 模型 model | `model/hmm_tvtp_hsmm/`、`model/factors/*` | **改动+新增** | 在 V7 中拆分出 `clusterer_dynamic/` 与 `hmm_tvtp_adaptive/`，引入慢锚驱动与漂移监测，同时复用校准与因子定义。 |
| 决策 decision | `decision/engine/*`, `decision/rules/*`, `decision/directional_classifier.py` | **改动** | 结合 clarity 与 transition 触发重塑仓位调度，保留 V6 的决策骨架但增加冷却与 drift 门控、transition rules 示例。 |
| 执行 execution | `execution/risk/*`, `execution/switch/*` | **继承** | 行为保持 open/reduce/close/all 结构，冷却 900s，继续沿用风控与路由策略。 |
| 验证 validation | `third_party/v6_legacy/validation/src/*` | **改动** | 复用通用统计脚本并增加 ECE、Brier、abstain_rate、prototype_drift 等门控阈值配置。 |
| 发布 output | `output/publish_docs/CHANGELOG.md`, `output/publish_docs/工程一致性与进度审计报告.md` | **改动** | V7 继续产出验证/变更文档，但需更新门控条件、签名流程与慢锚追踪。 |
| 文档 docs | `docs/工程日志_*`, `docs/logs/*` | **新增** | 汇总 V6 历史日志到 `docs/V6历史工程日志记录.md` 并保持可追溯。 |
| 卡片 todo | `order_flow_v_6_todo.md`, `docs/OrderFlow V6 — 任务卡片库V1.1.md` | **改动** | 输出映射 V7 任务的 `order_flow_v_7_todo.md`，覆盖 clusterer、TVTP、门控及编排等工作流。 |

---

## 可复用组件梳理

### 治理（governance）
- `SCHEMA_model.json`、`SCHEMA_decision.json`：当前定义状态空间、触发因子、执行审计字段。
- `CONTROL_switch_policy.yaml`：执行冷却与风控门控策略。
- `RULES_library.yaml`：集中维护触发动作与条件。

### 数据（data）
- `data/alignment/merge_to_features.py`：撮合 ATAS/行情并对齐到特征时间。
- `data/alignment/sessions.py`：维护交易会话边界。
- `data/preprocessing/fetch_kline.py`：抓取并缓存行情。
- `data/preprocessing/schemas/`：数据清洗 schema 校验。
- `data/preprocessing/utils/`：提供缺失值、时间索引工具。

### 特征（features）
- `features/macro_factor/macro_factor.py`：生成宏观级别指标与慢锚基础。
- `features/macro_factor/__init__.py`：暴露宏观特征工厂接口。

### 模型（model）
- `model/hmm_tvtp_hsmm/`：TVTP-HSMM 训练、推断与校准脚本。
- `model/factors/`：模型驱动因子定义与预处理。
- `model/calibration/`：后验校准与性能评估。

### 决策（decision）
- `decision/engine/__init__.py` 与调度逻辑：仓位与信号 orchestrator。
- `decision/directional_classifier.py`：方向判别器。
- `decision/rules/`：规则集合与审计钩子。

### 执行（execution）
- `execution/risk/volatility_cap.py` 等：风控与仓位限制。
- `execution/switch/`：开仓、减仓与冷却执行器。

### 验证（validation）
- `third_party/v6_legacy/validation/src/metrics.py`、`reporting.py`：指标与报表生成。
- `third_party/v6_legacy/validation/src/loaders/`：验证数据加载管线。

### 发布（output/publish_docs）
- `CHANGELOG.md`：发布节奏与版本描述。
- `工程一致性与进度审计报告.md`：门控与审计说明。

### 文档（docs）
- `工程日志_order_flow_v_6_*.md`：阶段性工程日志。
- `logs/`、`traceability.md`：合规与追溯材料。

### 任务卡片（todo）
- `order_flow_v_6_todo.md`：V6 活动任务。
- `docs/OrderFlow V6 — 任务卡片库V1.1.md`：任务细化与执行记录。

> 注：以上梳理供 V7 迁移对照使用，涉及 V7 新增模块需结合《OrderFlow V7 项目说明书（前瞻版，含工程对比）》执行。
