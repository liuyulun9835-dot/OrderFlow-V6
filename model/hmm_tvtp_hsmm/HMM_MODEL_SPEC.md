## ğŸ§  OrderFlow V6 â€” HMM æ¨¡å‹è¯´æ˜ä¹¦ï¼ˆç¨³å®šç‰ˆ v2.0ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `model/hmm_tvtp_hsmm/HMM_MODEL_SPEC.md`
**ç‰ˆæœ¬ï¼š** v2.0
**æ—¥æœŸï¼š** 2025-10-24
**ä½œè€…ï¼š** OrderFlow-V6 Core Team

---

### 1. æ¨¡å‹å®šä½ä¸ç›®æ ‡

* **æ ¸å¿ƒç›®æ ‡**ï¼šä»¥éšé©¬å°”å¯å¤«æ¨¡å‹ï¼ˆHMMï¼‰ä¸ºæ¡†æ¶ï¼ŒåŸºäº 1m ç²’åº¦è®¢å•æµå…ƒæ•°æ®æå–çš„äºŒçº§ç‰¹å¾ï¼Œè¯†åˆ«å¸‚åœºçš„ä¸¤ç§ç»“æ„çŠ¶æ€â€”â€”

  * å¹³è¡¡ï¼ˆBalance / Rotationï¼‰
  * å¤±è¡¡ï¼ˆImbalance / Trendï¼‰
    å¹¶é‡åŒ–å®ƒä»¬ä¹‹é—´çš„**ç›¸å˜æ¦‚ç‡**ã€‚
* **åº”ç”¨ç›®æ ‡**ï¼šä¸ºä¸Šå±‚çš„**å†³ç­–å¼•æ“ä¸æ–¹å‘æ€§åˆ¤æ–­å™¨**æä¾›çŠ¶æ€æ¦‚ç‡ä¸è½¬ç§»ä¿¡å·ï¼Œæ”¯æ’‘ 15-60 min æ—¶é—´å°ºåº¦çš„ç­–ç•¥é€»è¾‘ã€‚

---

### 2. æ¨¡å‹å½¢å¼ï¼ˆTwo-State TVTP-HMMï¼‰

æ¨¡å‹å‚æ•°ï¼š(\lambda = {\pi, A_t, B})

| å…ƒç´              | å®šä¹‰                                       | å®ç°è¯´æ˜                                      |                                 |
| -------------- | ---------------------------------------- | ----------------------------------------- | ------------------------------- |
| **éšè—çŠ¶æ€ (S)**   | ([S_1=\text{balance},,S_2=\text{trend}]) | äºŒå…ƒç»“æ„æ€ï¼›â€œç›¸å˜â€ä¸ç‹¬ç«‹æˆæ€ã€‚                          |                                 |
| **è½¬ç§»çŸ©é˜µ (A_t)** | (P(q_{t+1}=S_j                           | q_t=S_i,Z_t)=\sigma(\beta_{ij}^\top Z_t)) | TVTPï¼ˆæ—¶å˜è½¬ç§»ï¼‰ï¼›(Z_t) ä¸ºå¾®è§‚ä¸å®è§‚é©±åŠ¨ã€‚      |
| **å‘å°„åˆ†å¸ƒ (B)**   | (P(O_t                                   | q_t=S_j))                                 | å¯¹è§’é«˜æ–¯ / t åˆ†å¸ƒï¼›ä¼šè¯å†… z-score æ ‡å‡†åŒ–åå»ºæ¨¡ã€‚ |
| **åˆå§‹æ¦‚ç‡ (\pi)** | (P(q_1=S_i))                             | é»˜è®¤ (\pi=[0.9,0.1])ï¼Œå¯åœ¨æ¯ä¼šè¯é‡ç½®ã€‚               |                                 |

---

### 3. é©±åŠ¨ä¸è§‚æµ‹

#### 3.1 é©±åŠ¨å˜é‡ (Z_t)

* **å¾®è§‚å±‚**ï¼š`cvd_z`, `cvd_diff`, `bar_vpo_loc`, `absorption_flag`, `volume_z`, `range_z`
* **å®è§‚å±‚**ï¼š`close/MA200`, `rv_1h_pctl`

> æ‰€æœ‰ç‰¹å¾å‡å³é—­çª—å£ï¼ˆä»…ç”¨åˆ° t åŠä¹‹å‰æ•°æ®ï¼‰ã€‚

#### 3.2 è§‚æµ‹åºåˆ— (O_t)

```
O_t = [ret_1m, range_z, volume_z,
       cvd_z, bar_vpo_loc, absorption_flag, rv_1h_pctl]
```

* æ ‡å‡†åŒ–ï¼šä¼šè¯å†… z-score + winsorize (p1,p99)
* ç¼ºå¤±å¤„ç†ï¼šæ˜¾å¼ NaN maskï¼Œç¦æ­¢ ffill è¡¥é›¶ã€‚

---

### 4. å­¦ä¹ ä¸æ¨æ–­

#### 4.1 å­¦ä¹ ï¼ˆBaum-Welch / EMï¼‰

* å¤šèµ·ç‚¹ + AIC/BIC ç­›é€‰
* åˆ‡åˆ†ï¼šPurged K-Fold (k=5, embargo=5 bars)
* æ ¡éªŒï¼šè·¨æœŸ PSI / KS ç¨³å®šæ€§ > 0.8 æ–¹å¯å‘å¸ƒ

#### 4.2 æ¨æ–­è¾“å‡º

| è¾“å‡º                                                   | å«ä¹‰        | ç”¨é€”             |      |
| ---------------------------------------------------- | --------- | -------------- | ---- |
| (\gamma_t=P(q_t=S_2                                  | O_{1:t})) | å½“å‰å¤„äº trend æ¦‚ç‡  | çŠ¶æ€æ ‡ç­¾ |
| (\tau_t=P(q_{t+1}=S_2                                | q_t,Z_t)) | ä¸‹ä¸€æ­¥è½¬å…¥ trend æ¦‚ç‡ | ç›¸å˜å‰å…† |
| (\text{state}_t=\arg\max_j\gamma_t)                  | æœ€å¯èƒ½çŠ¶æ€     | å¯è§†åŒ– / å›æµ‹       |      |
| (\text{trigger}): (\tau_t>\theta) ä¸” (\dot\gamma_t>0) | ç›¸å˜å€™é€‰äº‹ä»¶    | é©±åŠ¨æ–¹å‘åˆ¤æ–­å™¨        |      |

---

### 5. æ–¹å‘æ€§åˆ¤æ–­å™¨æ¥å£

å½“è§¦å‘ (\tau_t>\theta) æ—¶è°ƒç”¨ï¼š

```
directional_classifier(O_{t-k:t})
 â†’ {label: bull/bear, confidence: 0â€“1}
```

å†™å…¥ `logs/decision_log.jsonl` å­—æ®µï¼š

```
{"trigger": {"prob":0.86,"threshold":0.80},
"directional_classifier":{"label":"bullish","confidence":0.91}}
```

---

### 6. æ¨¡å‹äº§å‡ºä¸å…ƒæ•°æ®

| æ–‡ä»¶                                        | è¯´æ˜                                                                          |
| ----------------------------------------- | --------------------------------------------------------------------------- |
| `model/artifacts/hmm_tvtp.pkl`            | æ¨¡å‹æƒé‡                                                                        |
| `model/artifacts/hmm_meta.json`           | å‚æ•°æ‘˜è¦ + å››é”®ç­¾åï¼ˆschema_version, build_id, data_manifest_hash, calibration_hashï¼‰ |
| `model/hmm_tvtp_hsmm/state_inference.py`  | æ¨æ–­æ¥å£                                                                        |
| `output/results/hmm_validation_report.md` | è®­ç»ƒä¸ç¨³å®šæ€§æŠ¥å‘Š                                                                    |

---

### 7. è§£é‡Šä¸è¯„ä¼°

* **åœç•™åˆ†å¸ƒ** ï¼šè¡¡é‡çŠ¶æ€é»æ€§ä¸å¹³å‡æŒç»­æ—¶é—´
* **ç¿»è½¬ç‡ / æ»ååˆ†å¸ƒ** ï¼šè¯„ä¼°æŠ–åŠ¨ä¸ååº”é€Ÿåº¦
* **æ–¹å‘è¯¯åˆ¤ç‡ + ECE** ï¼šéªŒè¯æ–¹å‘åˆ¤æ–­å™¨ä¸€è‡´æ€§
* **è·¨å¹´ä»½ PSI / KS** ï¼šæ¼‚ç§»æ£€æµ‹

---

### 8. é—¨æ§ä¸åˆè§„

* æ•°æ®æ¥æºéœ€é™„ manifest å“ˆå¸Œï¼›ç¼ºå¤±æˆ–ä¸ä¸€è‡´ â†’ æ‹’è®­
* æˆæœ¬/å¯è¾¾æ€§ Gate (å¡ 118) å¿…é¡»é€šè¿‡
* æ‰€æœ‰åˆ¶å“éœ€å†™å…¥ `release.yml` å¹¶ç­¾åç»‘å®š

---

### 9. æœªæ¥æ‰©å±•

* **HSMM é»æ€§çº¦æŸ** ï¼šæ·»åŠ æœ€å°åœç•™æ—¶é—´ â‰¥ k bars
* **Regime-switch AR æ··åˆ** ï¼šæ‰©å±•çŠ¶æ€è‡ªå›å½’å±‚
* **è´å¶æ–¯ TVTP-HMM** ï¼šåœ¨æ ·æœ¬ç¨€ç–åŒºä¼°è®¡è½¬ç§»å…ˆéªŒ

---

### 10. é™„å½• A ç¤ºä¾‹é…ç½®ç‰‡æ®µ

```
states: [balance, trend]
tvtp:
  enabled: true
  drivers: [cvd_z, bar_vpo_loc, close_ma200]
  link: logit
macro_factor_used: true
signatures:
  schema_version: v2.0
  build_id: 20251024
  data_manifest_hash: "<sha256>"
  calibration_hash: "<sha256>"
```

---

## ğŸ§© Codex æŒ‡ä»¤

```
# åœ¨ Git ä»“åº“çš„ model ç›®å½•ä¸­åˆ›å»ºå¹¶æäº¤ HMM è¯´æ˜ä¹¦
codex write-file --path "model/hmm_tvtp_hsmm/HMM_MODEL_SPEC.md" --from-template "HMMè¯´æ˜ä¹¦v2.0"
git add model/hmm_tvtp_hsmm/HMM_MODEL_SPEC.md
git commit -m "docs(model): add stable HMM_MODEL_SPEC v2.0 under model/hmm_tvtp_hsmm/"
git push origin main
```

---

æ‰§è¡Œåï¼ŒAI å¼€å‘ä»£ç†å°±èƒ½åœ¨è°ƒç”¨ `model/` æ—¶è¯»å–å¹¶éµå¾ªè¯¥è¯´æ˜æ–‡ä»¶ï¼Œç¡®ä¿åç»­è‡ªåŠ¨ç”Ÿæˆçš„ `train_tvtp.py` å’Œ `state_inference.py` ä¸æ­¤æ–‡æ¡£å®šä¹‰ä¸¥æ ¼ä¸€è‡´ã€‚
